#!/usr/bin/env ruby

require "optparse"
require "io/console"
require "oauth2"
require "webrick"
require "stringio"
require "pkce_challenge"

options = {}
parser = OptionParser.new do |parser|
  parser.banner = "Usage: #{$0} <command> [options]"
  parser.on "-h", "--help", "Get help" do
    puts parser
    exit
  end
end
parser.parse!

command = ARGV.shift

case command
when "login"
  client = OAuth2::Client.new("frobozz-client", "frobozz-client", site: "http://localhost:5555/")
  challenge = PkceChallenge.challenge
  auth_url = client.auth_code.authorize_url(
    redirect_uri: "http://127.0.0.1:9876",
    code_challenge: challenge.code_challenge,
    code_challenge_method: "S256"
  )
  puts "Please visit: #{auth_url}"
  puts "Waiting for confirmation..."
  logger = WEBrick::Log.new(StringIO.new) # shush
  redirect_server = WEBrick::HTTPServer.new(Port: 9876, Logger: logger)
  redirect_server.mount_proc "/" do |req, res|
    p req.body
    redirect_server.shutdown
  end
  redirect_server.start
else
  puts "I don't know how to #{command}"
  abort
end
